globals:
   - id: active_effect
     type: int
     restore_value: yes
     initial_value: '0' 
   - id: brightness
     type: int
     restore_value: yes
     initial_value: '0' 

esphome:
  name: "catears"
  on_boot:
    - light.turn_on:
        id: leds
        brightness: 25%
        effect: Rainbow Pulse

# Define the used hardware.
esp8266:
  board: d1_mini

# Enable logging.
logger:

# Enable OTA updates.
ota:
  - platform: esphome
    password: ""

wifi:
  # Attempt to connect to this wifi.
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  enable_on_boot: false

  # Enable fallback hotspot (captive portal) in case wifi connection fails.
  ap:
    ssid: "catears"
    password: !secret ap_password
    # Switch to access point mode early.
    ap_timeout: 5s
  
  on_connect:
    - light.turn_on:
        id: leds
        brightness: 25%
        effect: "Warning"
        red: 0%
        blue: 0%
        green: 100%

# Run webserver with dashboard to control cat ears.
web_server:
  # Allows accessing the webserver in ap mode at 192.168.4.1.
  local: true
  port: 80
  version: 3

# Setup the LEDs and effects.
light:
  - platform: neopixelbus
    id: leds
    type: GRB
    variant: WS2811
    pin: GPIO3
    num_leds: 25
    name: "NeoPixel Light"
    effects:
      - addressable_color_wipe:
          name: Random Color Wipe
      - addressable_rainbow:
          name: Rainbow Wipe
          speed: 40
          width: 10
      - addressable_scan:
          name: Scan Effect
          move_interval: 100ms
          scan_width: 3
      - addressable_fireworks:
          name: Fireworks Effect
          spark_probability: 30%
          use_random_color: true
      - addressable_lambda:
          name: Rainbow Pulse
          update_interval: 20ms
          lambda: |-
            static uint8_t h = 0;

            if (h > 365) {
              h = 0;
            }

            ESPHSVColor hsv_value(h, 255, 255);
            it.range(0, it.size()) = hsv_value.to_rgb();

            h = h+1;
      - addressable_lambda:
          name: Rainbow Wipe Improved
          update_interval: 25ms
          lambda: |-
            static uint16_t h = 0;

            if (h > 255) {
              h = 0;
            }

            uint16_t local_h = h;
            for (uint32_t i = 0; i < it.size(); i++) {
              ESPHSVColor hsv_value(local_h, 255, 255);
              it[i] = hsv_value.to_rgb();

              local_h = local_h + 2;
              if (local_h > 255) {
                local_h = 0;
              }
            }

            h = h+1;
      - addressable_lambda:
          name: Warning
          update_interval: 20ms
          lambda: |-
            const static uint16_t delta = 10;
            static uint32_t v = 0;

            if (v > 510) {
              v = 0;
            }

            uint32_t local_v = v;
            if (local_v > 255) {
              local_v = 510 - local_v;
            }

            local_v = (local_v*local_v) / 255;

            ESPHSVColor hsv_value(30, 255, local_v);
            it.range(0,delta) = hsv_value.to_rgb();
            it.range(delta,it.size()-delta) = Color(0,0,0);
            it.range(it.size()-delta,it.size()) = hsv_value.to_rgb();

            v = v+10;
      - addressable_lambda:
          name: Blitzer
          update_interval: 50ms
          lambda: |-
            const static uint16_t delta = 10;
            static uint16_t t = 0;

            if (t <= 5 || t == 8) {
              it.range(0,it.size()) = Color(0,0,0);
            } else {
              ESPHSVColor hsv_value(30, 255, 255);
              it.range(0,delta) = hsv_value.to_rgb();
              it.range(delta,it.size()-delta) = Color(0,0,0);
              it.range(it.size()-delta,it.size()) = hsv_value.to_rgb();
            }

            t = t+1;

            if (t > 10) {
              t = 0;
            }

binary_sensor:
  - platform: gpio
    pin: 
      number: GPIO16 #D0
      mode:
        input: true
        pulldown: true
    name: "Button"
    on_click:
      # Short press cycles through effects.
      - min_length: 5ms
        max_length: 350ms
        then:
          - lambda: !lambda |-
                        id(active_effect) += 1;
                        auto call = id(leds).turn_on();
                        switch (id(active_effect)) {
                          case 1:
                            call.set_effect("Random Color Wipe");
                            break;
                          case 2:
                            call.set_effect("Rainbow Wipe Improved");
                            break;
                          case 3:
                            call.set_effect("Rainbow Pulse");
                            break;
                          case 4:
                            call.set_effect("Warning");
                            break;
                          case 5:
                            call.set_effect("Blitzer");
                            break;
                          default:
                            id(active_effect) = 0;
                            call.set_effect("None");
                            break;
                        }
                        call.perform();
      # Long press cycles through brightness.
      - min_length: 500ms
        max_length: 2000ms
        then:
          - lambda: !lambda |-
                        id(brightness) += 1;
                        auto call = id(leds).turn_on();
                        switch (id(brightness)) {
                          case 1:
                            call.set_brightness(0.25);
                            break;
                          case 2:
                            call.set_brightness(0.5);
                            break;
                          case 3:
                            call.set_brightness(0.75);
                            break;
                          case 4:
                            call.set_brightness(1);
                            break;
                          default:
                            id(brightness) = 0;
                            call.set_brightness(0.125);
                            break;
                        }
                        call.perform();
      # Very long press >5s enables wifi.
      - min_length: 5000ms
        max_length: 10000ms
        then:
          - light.turn_on:
              id: leds
              brightness: 25%
              effect: Scan Effect
              red: 100%
              blue: 0%
              green: 0%
          - wifi.enable: